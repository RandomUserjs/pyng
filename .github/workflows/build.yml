name: Build Executables

on:
  push:
    tags: 
      - 'v*'
  workflow_dispatch:  # Permite executar manualmente pelo painel do GitHub

jobs:
  build:
    strategy:
      matrix:
        # Define os sistemas operacionais (runners) para compilar
        os: [ubuntu-latest, windows-latest] 

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Garantindo o Python 3.12
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12' # Versão estável com suporte a dependências

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pygame pyinstaller
        # Instala dependências Pygame e PyInstaller

    # --- Configurações Específicas do Windows ---
    - name: Set Console=False for Windows Build
      if: runner.os == 'Windows'
      run: |
        # Para que o jogo no Windows não abra o terminal preto
        (Get-Content app.spec) -replace 'console=True', 'console=False' | Set-Content app.spec
      shell: powershell

    # --- Etapa de Compilação (Dividida por OS) ---
    - name: Compile Executable (Linux; One-File)
      if: runner.os == 'Linux'
      run: |
        # O modo -F (One-File) é obrigatório para compatibilidade Linux.
        # Os --add-data garantem que as pastas 'Fonts', 'Sons' e 'classes' sejam incluídas.
        pyinstaller -F --name Pyng --add-data "Fonts:Fonts" --add-data "Sons:Sons" --add-data "classes:classes" app.py

    - name: Compile Executable (Windows; One-Dir)
      if: runner.os == 'Windows'
      run: |
        # Windows usa o app.spec (que configura o One-Dir por padrão)
        pyinstaller app.spec

    # --- ETAPA DE PREPARAÇÃO DOS ARTEFATOS ---
    - name: Zip Windows Artifact
      if: runner.os == 'Windows'
      run: |
          # Compacta toda a pasta dist/Pyng/ em um único arquivo ZIP
          7z a -r pyng-win.zip dist/Pyng/
      shell: cmd # Usa o shell de comando para o 7z

    # --- PASSO DE UPLOAD DE ARTEFATOS ---
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pyng-build-${{ matrix.os }}
        path: |
          dist/         # Binário Linux (arquivo único)
          dist/Pyng/pyng-win.zip  # ZIP do Windows (arquivo único)
        retention-days: 7
  
  release:
    name: Create GitHub Release
    # Roda somente após o job 'build' ter sido concluído com sucesso
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: write # Concede permissão de escrita para criar a Release
    
    # Condição para rodar apenas em tags (ex: v1.0, v1.1)
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all build artifacts
      # Baixa os arquivos compilados (Linux e Windows)
      uses: actions/download-artifact@v4
      with:
        path: artifacts # Baixa os arquivos para uma pasta chamada 'artifacts'

    - name: List downloaded files (for debug)
      run: ls -R artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        # Pega o nome da tag (ex: v1.0) para o título da Release
        tag_name: ${{ github.ref_name }}
        name: Pyng - Release ${{ github.ref_name }}
        body: |
          Este é o lançamento ${{ github.ref_name }} do jogo Pyng.
          
          Assets incluídos:
          - Binário Linux
          - Executável Windows
        draft: false # Lança publicamente
        prerelease: false
        files: artifacts/**/* # Anexa todos os executáveis e zips baixados
      env:
        # O GitHub fornece este token automaticamente
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}